# import standard modules
import logging
import sys
import json
import os
import argparse

# import 3rd party modules

# import local modules
from gcp_utils.settings import (
    GOOGLE_CLOUD_PROJECT,
    GOOGLE_COMPUTE_REGION,
    GOOGLE_PUBSUB_TOPIC,
    logger
)

# import common modules
from gcp_utils import pubsub
from cloud_processor import input_message


# set the logging level to always be DEBUG in this module
logger.setLevel(logging.DEBUG)

def run_prediction_server():
    # Define your data and attributes.  These are optional and only used for filtering messages.
    attributes = {}
    sub_topic_id = GOOGLE_PUBSUB_TOPIC  

    logger.info(f"Creating a subscription for topic: {sub_topic_id}")
    subscription_id = pubsub.subscription(topic_id=sub_topic_id, subscription_id="prediction_server", **attributes)

    logger.debug(f'Created a subscription: {subscription_id}')
    pubsub.delete_when_done(name=subscription_id)

    # loop until receiving a signal to exit.
    try:
        while True:
            # Pull the message
            logging.debug(f"Pull messages: on {pub_topic_id} using subscription {subscription_id}")
            messages = pubsub.pull(topic_id=sub_topic_id, subscription_id=subscription_id)

            # Print the messages
            for message in messages:
                logger.info(message.text, message.attributes)

    except KeyboardInterrupt:
        logger.info(f'keyboard interrupt received...exiting')

    # delete the subscription
    logger.info(f'deleting subscription: {subscription_id}')
    pubsub.delete(name=subscription_id)

def run_prediction_client():

    pub_topic_id = GOOGLE_PUBSUB_TOPIC

    # loop getting command line input, exit loop when ctrl+c
    while True:
        try:
            # input an alloy
            alloy = input("Enter an alloy to predict: ")
            if alloy == "exit":
                break

            # input a crystal type
            crystal = input("Enter a crystal type: ")
            if crystal == "exit":
                break

        except KeyboardInterrupt:
            logger.info(f'keyboard interrupt received...exiting')
            sys.exit(0)

            break

        # create dataclass with inputte data
        data = input_message(alloy, crystal)
        logger.debug(f"dataclass to be sent to prediction server: {data}")

        # convert dataclass to json
        data = json.dumps(data).encode('utf-8')
        logger.info(f"json message to publish: {data}")

        # Define your data and attributes.  These are optional and only used for filtering messages.
        attributes = {}
        
        # Publish the message
        logger.debug(f"Publish the message: {data} on topic {pub_topic_id}")
        pubsub.publish(data, topic_id=pub_topic_id, **attributes)


# main function
if __name__ == "__main__":

    # check input flags for --server
    parser = argparse.ArgumentParser()
    parser.add_argument("--server", help="Run the prediction server", action="store_true")

    # check input flags for --client
    parser.add_argument("--client", help="Run the prediction client", action="store_true")

    # parse the input arguments 
    args = parser.parse_args()

    try: 
        if args.server:
            run_prediction_server()
        elif args.client:
            run_prediction_client()
        else:
            logger.error("Please specify --server or --client")
    except Exception as e:
        logger.error(f"Error {e}in running the prediction server or client")
        sys.exit(1)


    # exit the program
    sys.exit(0)



